{
	"info": {
		"_postman_id": "504da8bb-9001-4cef-913e-d66c5722a6bc",
		"name": "SecureDocStoreAPI",
		"description": "This suite contains integration tests for the Secure Document Storage API. A Pre-request script is configured to ensure all tests resolve a valid auth token should they need it",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "20091732"
	},
	"item": [
		{
			"name": "SDSHealthCheckTests",
			"item": [
				{
					"name": "Health Check",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Test to check the health of the API",
									"pm.test(\"Response code is 200\", function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response body shows health status\", function() {",
									"    var responseBody = pm.response.json();",
									"    pm.expect(responseBody).to.be.an('object');",
									"    pm.expect(responseBody).to.have.property('Health', 'OK');",
									"});",
									""
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{SDSBaseUrl}}/health",
							"host": [
								"{{SDSBaseUrl}}"
							],
							"path": [
								"health"
							]
						},
						"description": "Expect a 200 OK response from /health"
					},
					"response": []
				}
			],
			"description": "Tests on the /health endpoint"
		},
		{
			"name": "SDSAuthTests",
			"item": [
				{
					"name": "Missing token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"response code is 403\", function() {",
									"    pm.response.to.have.status(403);",
									"});",
									"",
									"",
									"pm.test(\"response message is not authenticated\", function() {",
									"    var responseBody = pm.response.json();",
									"    pm.expect(responseBody).to.eql(\"Forbidden\");",
									"});"
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"packages": {},
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{SDSBaseUrl}}/retrieve_file?file_key=README.md",
							"host": [
								"{{SDSBaseUrl}}"
							],
							"path": [
								"retrieve_file"
							],
							"query": [
								{
									"key": "file_key",
									"value": "README.md"
								}
							]
						},
						"description": "Expect a 403 FORBIDDEN with no bearer token"
					},
					"response": []
				},
				{
					"name": "Invalid scope token",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Runs before invalid scope test",
									"",
									"function postRequest(secret) {",
									"    const postRequest = {",
									"        url: tokenUrl,",
									"        method: 'POST',",
									"        header: {",
									"            'Content-Type': 'application/x-www-form-urlencoded'",
									"        },",
									"        body: {",
									"            mode: 'urlencoded',",
									"            urlencoded:",
									"                [",
									"                    { key: 'grant_type', value: 'client_credentials' },",
									"                    { key: 'client_id', value: clientId },",
									"                    { key: 'client_secret', value: secret },",
									"                    { key: 'scope', value: scope }",
									"                ]",
									"        }",
									"    };",
									"",
									"    pm.sendRequest(postRequest, (error, response) => {",
									"        let jsonData = response.json()",
									"        pm.variables.set(\"bearerToken\", jsonData.access_token)",
									"    })",
									"}",
									"",
									"// resolve variables from the environment",
									"const tokenUrl = 'https://login.microsoftonline.com/c6874728-71e6-41fe-a9e1-2e8c36776ad8/oauth2/v2.0/token'",
									"const clientId = pm.environment.get('SDSClientID')",
									"const scope = pm.environment.get('InvalidScope')",
									"var envSecret = pm.environment.get('SDSClientSecret')",
									"",
									"// locally resolve secret from vault, in pipeline use env var\",",
									"if (envSecret.startsWith('{{vault:')) {",
									"    secretKey = envSecret.replace('{{vault:', '').replace('}}', '')",
									"    // use .then() in place of await to support newman runner",
									"    pm.vault.get(secretKey).then(vaultValue => postRequest(vaultValue))",
									"}",
									"else {",
									"    postRequest(envSecret)",
									"}"
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Test invalid scope token",
									"pm.test(\"response code is 401\", function() {",
									"    pm.response.to.have.status(401);",
									"});",
									"",
									"pm.test(\"Response body shows Invalid Token\", function() {",
									"    var responseBody = pm.response.json();",
									"    pm.expect(responseBody).to.be.an('object');",
									"    pm.expect(responseBody).to.have.property('detail', 'Invalid or expired token');",
									"});"
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "bearer {{bearerTokenInvalid}}",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{SDSBaseUrl}}/retrieve_file?file_key=README.md",
							"host": [
								"{{SDSBaseUrl}}"
							],
							"path": [
								"retrieve_file"
							],
							"query": [
								{
									"key": "file_key",
									"value": "README.md"
								}
							]
						},
						"description": "Expect a 403 FORBIDDEN when using a token with the wrong scope (resolved in pre-request)"
					},
					"response": []
				}
			],
			"description": "Tests to ensure auth fails on invalid requests"
		},
		{
			"name": "SDSSaveFileTests",
			"item": [
				{
					"name": "Save File",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response body shows success\", function() {",
									"    var responseBody = pm.response.json();",
									"    pm.expect(responseBody).to.be.an('object');",
									"    pm.expect(responseBody).to.have.property('success', 'Files Saved successfully in ' + pm.environment.get('SDSBucket') + ' with key test_file.md ');",
									"});"
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "bearer {{bearerToken}}",
								"type": "text"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "file",
									"type": "file",
									"src": "test_file.md"
								},
								{
									"key": "body",
									"value": "{\"bucketName\":\"{{SDSBucket}}\"} ",
									"type": "text"
								}
							]
						},
						"url": {
							"raw": "{{SDSBaseUrl}}/save_file",
							"host": [
								"{{SDSBaseUrl}}"
							],
							"path": [
								"save_file"
							]
						},
						"description": "Expect a 200 OK when saving a file. See repo README for instructions related to the file"
					},
					"response": []
				},
				{
					"name": "Save file with virus",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 400\", function () {",
									"    pm.response.to.have.status(400);",
									"});",
									"",
									"pm.test(\"Check response detail for Virus Found\", function () {",
									"    var responseBody = pm.response.json();",
									"    pm.expect(responseBody).to.eql({\"detail\": [\"Virus Found\"]});",
									"});"
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "bearer {{bearerToken}}",
								"type": "text"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "file",
									"type": "file",
									"src": "eicar.txt"
								},
								{
									"key": "body",
									"value": "{\"bucketName\":\"{{SDSBucket}}\", \"folder\":\"testmult\"} ",
									"type": "text"
								}
							]
						},
						"url": {
							"raw": "{{SDSBaseUrl}}/save_file",
							"host": [
								"{{SDSBaseUrl}}"
							],
							"path": [
								"save_file"
							]
						},
						"description": "Expect a 400 BAD REQUEST when saving the eicar mock virus file"
					},
					"response": []
				},
				{
					"name": "Save file with missing bucket",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 400\", function () {",
									"    pm.response.to.have.status(400);",
									"});",
									"pm.test(\"Response has required fields\", function () {",
									"    var responseBody = pm.response.json();",
									"    pm.expect(responseBody).to.have.property('detail');",
									"    pm.expect(responseBody.detail).to.have.property('bucketName');",
									"    pm.expect(responseBody.detail.bucketName).to.eql('Field required');",
									"});"
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "bearer {{bearerToken}}",
								"type": "text"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "file",
									"type": "file",
									"src": "test_file.md"
								},
								{
									"key": "body",
									"value": "{\"folder\":\"testmult\"} ",
									"type": "text"
								}
							]
						},
						"url": {
							"raw": "{{SDSBaseUrl}}/save_file",
							"host": [
								"{{SDSBaseUrl}}"
							],
							"path": [
								"save_file"
							]
						},
						"description": "Expect a 400 BAD REQUEST when no bucket is defined in the save request"
					},
					"response": []
				},
				{
					"name": "Save file without file",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 400\", function () {",
									"    pm.response.to.have.status(400);",
									"",
									"});",
									"",
									"pm.test(\"Response has required fields\", function () {",
									"    var responseBody = pm.response.json();",
									"    pm.expect(responseBody).to.have.property('detail');",
									"    pm.expect(responseBody.detail).to.include('File is required');",
									"});"
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "bearer {{bearerToken}}",
								"type": "text"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "file",
									"type": "file",
									"src": []
								},
								{
									"key": "body",
									"value": "{\"bucketName\":\"{{SDSBucket}}\", \"folder\":\"testmult\"} ",
									"type": "text"
								}
							]
						},
						"url": {
							"raw": "{{SDSBaseUrl}}/save_file",
							"host": [
								"{{SDSBaseUrl}}"
							],
							"path": [
								"save_file"
							]
						},
						"description": "Expect a 400 BAD REQUEST when calling save_file without a file"
					},
					"response": []
				}
			],
			"description": "Tests on the /save_file endpoint",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"type": "text/javascript",
						"packages": {},
						"exec": [
							""
						]
					}
				},
				{
					"listen": "test",
					"script": {
						"type": "text/javascript",
						"packages": {},
						"exec": [
							""
						]
					}
				}
			]
		},
		{
			"name": "SDSRetrieveFileTests",
			"item": [
				{
					"name": "Retrieve File",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Test retrieve file",
									"pm.test(\"response code is 200\", function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"response contains fileURL key\", function() {",
									"    const responseBody = pm.response.json();",
									"    pm.expect(responseBody).to.have.property('fileURL').that.is.a('string');",
									"});"
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "bearer {{bearerToken}}",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{SDSBaseUrl}}/retrieve_file?file_key=test_file.md",
							"host": [
								"{{SDSBaseUrl}}"
							],
							"path": [
								"retrieve_file"
							],
							"query": [
								{
									"key": "file_key",
									"value": "test_file.md"
								}
							]
						},
						"description": "Run 'Save File' request first then expect 200 OK"
					},
					"response": []
				},
				{
					"name": "Retrieve Non-Existent File",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Test to verify getting a 404 response for a non-existent file",
									"pm.test(\"Status code is 404\", function () {",
									"    pm.response.to.have.status(404);",
									"});",
									"",
									"pm.test(\"Response body shows file not found\", function() {",
									"    var responseBody = pm.response.json();",
									"    pm.expect(responseBody).to.be.an('object');",
									"    pm.expect(responseBody).to.have.property('detail', 'The file non_existent could not be found.');",
									"});"
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "bearer {{bearerToken}}",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{SDSBaseUrl}}/retrieve_file?file_key=non_existent",
							"host": [
								"{{SDSBaseUrl}}"
							],
							"path": [
								"retrieve_file"
							],
							"query": [
								{
									"key": "file_key",
									"value": "non_existent"
								}
							]
						},
						"description": "Expect 404 NOT FOUND when requesting a file that does not exist"
					},
					"response": []
				}
			],
			"description": "Test on the /retrieve_file endpoint"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"packages": {},
				"exec": [
					"// Always runs before every request",
					"",
					"function postRequest(secret) {",
					"    const postRequest = {",
					"        url: tokenUrl,",
					"        method: 'POST',",
					"        header: {",
					"            'Content-Type': 'application/x-www-form-urlencoded'",
					"        },",
					"        body: {",
					"            mode: 'urlencoded',",
					"            urlencoded:",
					"                [",
					"                    { key: 'grant_type', value: 'client_credentials' },",
					"                    { key: 'client_id', value: clientId },",
					"                    { key: 'client_secret', value: secret },",
					"                    { key: 'scope', value: scope }",
					"                ]",
					"        }",
					"    };",
					"",
					"    pm.sendRequest(postRequest, (error, response) => {",
					"        let jsonData = response.json()",
					"        pm.variables.set(\"bearerToken\", jsonData.access_token)",
					"    })",
					"}",
					"",
					"// resolve variables from the environment",
					"const tokenUrl = 'https://login.microsoftonline.com/c6874728-71e6-41fe-a9e1-2e8c36776ad8/oauth2/v2.0/token'",
					"const clientId = pm.environment.get('SDSClientID')",
					"const scope = pm.environment.get('ValidScope')",
					"var envSecret = pm.environment.get('SDSClientSecret')",
					"",
					"// locally resolve secret from vault, in pipeline use env var\",",
					"if (envSecret.startsWith('{{vault:')) {",
					"    secretKey = envSecret.replace('{{vault:', '').replace('}}', '')",
					"    // use .then() in place of await to support newman runner",
					"    pm.vault.get(secretKey).then(vaultValue => postRequest(vaultValue))",
					"}",
					"else {",
					"    postRequest(envSecret)",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"packages": {},
				"exec": [
					""
				]
			}
		}
	]
}